<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camps & Combines</title>

  <style>
    :root{
      --accent: #dc2626; /* matches Tailwind red-600 */
      --bg: #f3f4f6;     /* gray-100-ish */
      --text: #111827;   /* gray-900-ish */
      --muted: #6b7280;  /* gray-500-ish */
      --card: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,.08);

      --pagePad: 16px;
      --tableMinW: 920px;
    }

    *{ box-sizing: border-box; }

    html, body{
      height: 100%;
      width: 100%;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{ color: inherit; }

    /* Header */
    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(243,244,246,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.8);
    }

    .wrap{
      width: 100%;
      max-width: 1152px;
      margin: 0 auto;
      padding: 16px;
      padding-left: max(16px, env(safe-area-inset-left));
      padding-right: max(16px, env(safe-area-inset-right));
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 10px;
      padding-top: 8px;
      padding-bottom: 10px;
    }

    .brand img{
      height: 44px;
      width: auto;
      display:block;
    }

    .brand h1{
      margin: 0;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.05;
      font-size: 36px;
    }

    .brand .line{
      width: min(980px, 92%);
      height: 4px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 90%, transparent);
      margin-top: 6px;
    }

    @media (min-width: 900px){
      .brand h1{ font-size: 54px; }
      .brand img{ height: 52px; }
    }

    /* Controls */
    .controls{
      display: grid;
      gap: 10px;
      align-items: end;
      width: 100%;
      margin-top: 10px;
    }
    .controls > *{ min-width: 0; }

    .controls label{
      display:block;
      font-size:12px;
      font-weight: 800;
      color:#374151;
      margin-bottom:6px;
    }

    .controls input, .controls select{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      font-size: 14px;
      min-width: 0;
      outline: none;
    }
    .controls input:focus, .controls select:focus{
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    @media (min-width: 1100px){
      .controls{ grid-template-columns: 2fr 160px 220px 170px 170px 190px; }
    }
    @media (max-width: 1099px){
      .controls{ grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); }
    }

    .pillWrap{ display:flex; flex-direction:column; min-width:0; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-size:14px;
      width:100%;
      user-select:none;
      font-weight: 800;
      color:#111;
    }
    .pill input{ width:18px; height:18px; flex:0 0 auto; accent-color: var(--accent); }

    .metaRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      margin-top:12px;
      align-items:center;
      width:100%;
    }
    @media (max-width:760px){
      .metaRow{ grid-template-columns: 1fr; }
      .actionsRow{ justify-content:flex-start; }
    }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color: var(--muted);
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      font-weight: 800;
      color:#374151;
    }

    .actionsRow{
      display:inline-flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .viewToggle{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      max-width:100%;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
    }
    .viewToggle button{
      border:0;
      background:transparent;
      padding:8px 14px;
      font-weight: 900;
      font-size:12px;
      cursor:pointer;
      color:#374151;
      white-space:nowrap;
    }
    .viewToggle button.active{
      background:#111827;
      color:#fff;
    }

    .resetBtn{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 14px;
      border-radius:12px;
      font-weight: 900;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
    }

    main{
      width:100%;
      max-width:100%;
      padding: var(--pagePad);
      padding-left: max(var(--pagePad), env(safe-area-inset-left));
      padding-right: max(var(--pagePad), env(safe-area-inset-right));
      padding-bottom: 80px;
    }

    .error{
      width:100%;
      max-width:1152px;
      margin: 12px auto 0;
      padding: 12px 14px;
      background: #fff3f3;
      border: 1px solid #ffd0d0;
      border-radius: 14px;
      color:#7a0000;
      font-weight:900;
      box-shadow: var(--shadow);
    }

    /* Cards */
    .grid{
      width:100%;
      max-width:1152px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      width:100%;
    }
    .row1{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .left{ min-width:0; }

    .title{
      font-size:16px;
      font-weight: 900;
      margin:0 0 6px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
      word-break:break-word;
      cursor:pointer;
    }
    .title.expanded{ display:block; -webkit-line-clamp:unset; }
    .sub{ font-size:13px; color:#374151; margin:0; font-weight: 700; }

    .stamp{
      display:inline-flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#f9fafb;
      min-width:132px;
      max-width:170px;
      flex:0 0 auto;
    }
    .stampDate{ font-weight: 900; font-size:14px; line-height:1.1; text-align:right; }
    .stampState{ font-size:12px; color:#6b7280; font-weight: 900; letter-spacing:.02em; }

    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      white-space:nowrap;
      color:#374151;
      font-weight: 800;
    }

    .actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }

    /* Match “College Database” black pill buttons */
    .btn{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid #111827;
      background:#111827;
      text-decoration:none;
      color:#fff;
      font-weight: 900;
      font-size:14px;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .btn.secondary{
      background:#fff;
      color:#111827;
      border-color: var(--border);
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
    }

    /* Table */
    .tableOuter{ width:100%; max-width:100%; }
    .tableWrap{ width:100%; max-width:1152px; margin:0 auto; }

    /* IMPORTANT: keep page scrollable; only the table scrolls horizontally */
    .tableScroll{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);

      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      width:100%;
      max-width:100%;
      position: relative;

      /* helps iOS allow sideways pan */
      touch-action: pan-x pan-y;
    }

    table{
      width:100%;
      min-width: var(--tableMinW);
      border-collapse: separate;
      border-spacing: 0;
    }

    th, td{
      padding:12px;
      border-bottom:1px solid #f0f0f0;
      font-size:13px;
      vertical-align:top;
      color:#111827;
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 11;
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:12px;
      color:#374151;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      font-weight: 900;
    }

    thead th .sort{ font-weight:900; margin-left:6px; opacity:.6; font-size:12px; }

    tr:hover td{ background:#fcfcfc; }

    /* Make links obvious like College Database */
    td a{
      color: color-mix(in srgb, var(--accent) 85%, #111827);
      font-weight: 900;
      text-decoration: none;
    }
    td a:hover{ text-decoration: underline; }

    .hidden{ display:none !important; }

    .empty{
      width:100%;
      max-width:1152px;
      margin:14px auto 0;
      padding:14px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      color:#374151;
      font-size:14px;
      font-weight: 900;
    }

    #sentinel{ height:1px; width:100%; max-width:1152px; margin:0 auto; }

    @media (max-width:760px){
      :root{ --tableMinW: 980px; } /* force horizontal scroll on mobile */
      .brand h1{ font-size: 34px; }
      .brand img{ height: 42px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <img src="https://colleges.myrecruits.org/logo-black.png" alt="My Recruits" />
        <h1>Camps &amp; Combines</h1>
        <div class="line"></div>
      </div>

      <div class="controls">
        <div>
          <label>Search</label>
          <input id="q" placeholder="School, camp name, host..." />
        </div>

        <div>
          <label>State</label>
          <select id="state"><option value="">All</option></select>
        </div>

        <div>
          <label>Hosted By</label>
          <select id="host"><option value="">All</option></select>
        </div>

        <div>
          <label>Start date</label>
          <input id="from" type="date" />
        </div>

        <div>
          <label>End date</label>
          <input id="to" type="date" />
        </div>

        <div class="pillWrap">
          <label>&nbsp;</label>
          <label class="pill">
            <input id="upcoming" type="checkbox" checked />
            <span>Upcoming only</span>
          </label>
        </div>
      </div>

      <div class="metaRow">
        <div class="meta">
          <span class="badge" id="count">Loading…</span>
          <span class="badge" id="updated"></span>
          <span class="badge" id="sortLabel"></span>
        </div>

        <div class="actionsRow">
          <button class="resetBtn" id="resetBtn" type="button">Reset filters</button>
          <div class="viewToggle" role="group" aria-label="View mode">
            <button id="btnCards" type="button">Cards</button>
            <button id="btnTable" type="button">Table</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="error" class="error hidden"></div>

    <div class="grid" id="cards"></div>

    <div class="tableOuter">
      <div class="tableWrap hidden" id="tableWrap">
        <div class="tableScroll" id="tableScroll">
          <table>
            <thead>
              <tr>
                <th data-key="DATE" style="width:150px;">Date <span class="sort"></span></th>
                <th data-key="STATE" style="width:70px;">State <span class="sort"></span></th>
                <th data-key="EVENT">Event <span class="sort"></span></th>
                <th data-key="HOST" style="width:240px;">Hosted by <span class="sort"></span></th>
                <th data-key="COST" style="width:120px;">Cost <span class="sort"></span></th>
                <th data-key="DURATION" style="width:120px;">Duration <span class="sort"></span></th>
                <th data-key="GRADES" style="width:170px;">Grades <span class="sort"></span></th>
                <th data-key="URL" style="width:90px;">Link <span class="sort"></span></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="empty hidden" id="empty">No events match your filters.</div>
    <div id="sentinel"></div>
  </main>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTMvr__OkB3wgl4GvpZLJ61u_MfemESGiLBKEwufYFVwj_S7jiHFZraACGJRJogY6I29r17w34EGzVF/pub?gid=700608427&single=true&output=csv";
    const PAGE_SIZE = 100;
    const STORAGE_KEY_VIEW = "myrecruits_view_mode_camps";

    const els = {
      q: document.getElementById("q"),
      state: document.getElementById("state"),
      host: document.getElementById("host"),
      from: document.getElementById("from"),
      to: document.getElementById("to"),
      upcoming: document.getElementById("upcoming"),
      count: document.getElementById("count"),
      updated: document.getElementById("updated"),
      sortLabel: document.getElementById("sortLabel"),
      cards: document.getElementById("cards"),
      rows: document.getElementById("rows"),
      tableWrap: document.getElementById("tableWrap"),
      tableScroll: document.getElementById("tableScroll"),
      btnCards: document.getElementById("btnCards"),
      btnTable: document.getElementById("btnTable"),
      resetBtn: document.getElementById("resetBtn"),
      sentinel: document.getElementById("sentinel"),
      empty: document.getElementById("empty"),
      error: document.getElementById("error"),
      thead: document.querySelector("thead"),
      ths: Array.from(document.querySelectorAll("thead th")),
    };

    let all = [];
    let filtered = [];
    let visibleLimit = PAGE_SIZE;
    let observer = null;

    let sortKey = "DATE";
    let sortDir = "asc";

    init().catch(showFatal);

    async function init() {
      const started = performance.now();
      const csv = await fetch(CSV_URL, { cache: "no-store" }).then(r => {
        if (!r.ok) throw new Error("CSV fetch failed: " + r.status);
        return r.text();
      });

      const parsed = parseCsv(csv);
      const map = buildHeaderMap(parsed.headers);

      const missing = [];
      if (map.STATE < 0) missing.push("STATE");
      if (map.DATE < 0) missing.push("DATE");
      if (map.EVENT < 0) missing.push("EVENT NAME");
      if (map.URL < 0) missing.push("URL/LINK");
      if (missing.length) throw new Error("Spreadsheet columns missing or renamed: " + missing.join(", "));

      all = parsed.rows
        .map(r => rowObj(map, r))
        .map(r => normalizeRow(r))
        .filter(r => r.URL && r.EVENT && r._date instanceof Date && !isNaN(r._date.getTime()));

      hydrateFilters(all);

      const ms = Math.round(performance.now() - started);
      els.updated.textContent = `Loaded ${all.length} events • ${ms}ms`;

      wire();
      applyDefaultView();
      updateSortIndicators();
      render({ reset: true });
      setupInfiniteScroll();
    }

    function showFatal(err){
      console.error(err);
      els.error.textContent =
        "The camps table couldn’t load. Usually this means the Google Sheet column names were changed. " +
        "Fix the sheet headers or update the app. Error: " + (err && err.message ? err.message : String(err));
      els.error.classList.remove("hidden");
      els.count.textContent = "Load failed";
      wire();
      applyDefaultView();
    }

    function buildHeaderMap(headers){
      const norm = headers.map(h => String(h || "").trim().toUpperCase());
      const idx = (aliases) => {
        for (const a of aliases){
          const i = norm.indexOf(a);
          if (i >= 0) return i;
        }
        return -1;
      };

      return {
        STATE: idx(["STATE","ST"]),
        DATE: idx(["DATE","EVENT DATE"]),
        EVENT: idx(["EVENT NAME","EVENT","CAMP NAME","NAME"]),
        HOST: idx(["HOSTED BY","HOST","HOST SCHOOL","SCHOOL"]),
        URL: idx(["URL","LINK","REGISTRATION LINK","REGISTER","WEBSITE"]),
        COST: idx(["COST","PRICE","FEE"]),
        DURATION: idx(["DURATION","LENGTH"]),
        GRADES: idx(["GRADES/AGE","GRADES","AGE","GRADES AGE"]),
        APPROVED: idx(["APPROVED","APPROVAL"])
      };
    }

    function rowObj(map, row) {
      const get = (i) => (i >= 0 ? (row[i] ?? "") : "");
      return {
        STATE: get(map.STATE),
        DATE: get(map.DATE),
        EVENT: get(map.EVENT),
        HOST: get(map.HOST),
        URL: get(map.URL),
        COST: get(map.COST),
        DURATION: get(map.DURATION),
        GRADES: get(map.GRADES),
        APPROVED: get(map.APPROVED),
      };
    }

    function isDesktop() {
      return window.matchMedia("(min-width: 900px)").matches;
    }

    function applyDefaultView() {
      const saved = (localStorage.getItem(STORAGE_KEY_VIEW) || "").toLowerCase();
      const fallback = isDesktop() ? "table" : "cards";
      const mode = (saved === "cards" || saved === "table") ? saved : fallback;
      setView(mode, { persist: false });
    }

    function setView(mode, opts = { persist: true }) {
      const m = mode === "table" ? "table" : "cards";
      const persist = opts.persist !== false;

      els.btnCards.classList.toggle("active", m === "cards");
      els.btnTable.classList.toggle("active", m === "table");

      els.cards.classList.toggle("hidden", m !== "cards");
      els.tableWrap.classList.toggle("hidden", m !== "table");

      if (persist) localStorage.setItem(STORAGE_KEY_VIEW, m);

      if (m === "table") {
        // helpful on mobile: jump to table but keep page scrollable
        requestAnimationFrame(() => els.tableWrap.scrollIntoView({ block: "start", behavior: "smooth" }));
      }
    }

    function setupInfiniteScroll() {
      if (observer) observer.disconnect();
      observer = new IntersectionObserver((entries) => {
        if (!entries.some(e => e.isIntersecting)) return;
        if (visibleLimit >= filtered.length) return;
        visibleLimit = Math.min(filtered.length, visibleLimit + PAGE_SIZE);
        paint();
      }, { root: null, rootMargin: "1200px 0px", threshold: 0 });
      observer.observe(els.sentinel);
    }

    function wire() {
      const resetAndRender = () => render({ reset: true });

      ["input", "change"].forEach(evt => {
        els.q.addEventListener(evt, resetAndRender);
        els.state.addEventListener(evt, resetAndRender);
        els.host.addEventListener(evt, resetAndRender);
        els.from.addEventListener(evt, resetAndRender);
        els.to.addEventListener(evt, resetAndRender);
        els.upcoming.addEventListener(evt, resetAndRender);
      });

      els.btnCards.addEventListener("click", () => setView("cards"));
      els.btnTable.addEventListener("click", () => setView("table"));

      els.resetBtn.addEventListener("click", () => {
        els.q.value = "";
        els.state.value = "";
        els.host.value = "";
        els.from.value = "";
        els.to.value = "";
        els.upcoming.checked = true;

        sortKey = "DATE";
        sortDir = "asc";
        updateSortIndicators();
        render({ reset: true });
      });

      els.thead.addEventListener("click", (e) => {
        const th = e.target.closest("th");
        if (!th) return;
        const key = th.getAttribute("data-key");
        if (!key) return;

        if (sortKey === key) sortDir = (sortDir === "asc" ? "desc" : "asc");
        else { sortKey = key; sortDir = "asc"; }

        updateSortIndicators();
        render({ reset: true });
      });

      els.cards.addEventListener("click", (e) => {
        const t = e.target.closest(".title");
        if (t) t.classList.toggle("expanded");
      });
    }

    function render({ reset }) {
      if (!all.length) return;
      if (reset) visibleLimit = PAGE_SIZE;

      const q = (els.q.value || "").trim().toLowerCase();
      const state = els.state.value;
      const host = els.host.value;
      const from = els.from.value ? new Date(els.from.value + "T00:00:00") : null;
      const to = els.to.value ? new Date(els.to.value + "T00:00:00") : null;
      const upcomingOnly = els.upcoming.checked;
      const today = startOfDay(new Date());

      filtered = all.filter(r => {
        if (upcomingOnly && r._date < today) return false;
        if (state && r.STATE !== state) return false;
        if (host && r.HOST !== host) return false;
        if (from && r._date < from) return false;
        if (to && r._date > to) return false;

        if (q) {
          const blob = [
            r.STATE, r.DATE, r.EVENT, r.HOST, r.URL,
            r.COST || "", r.DURATION || "", r.GRADES || ""
          ].join(" ").toLowerCase();
          if (!blob.includes(q)) return false;
        }

        if (r.APPROVED !== null && r.APPROVED !== true) return false;
        return true;
      });

      sortRows(filtered);
      paint();
    }

    function paint() {
      const slice = filtered.slice(0, visibleLimit);
      els.count.textContent = `Showing ${slice.length} of ${filtered.length} event(s)`;
      els.empty.classList.toggle("hidden", filtered.length !== 0);
      renderCards(slice);
      renderTable(slice);
    }

    function sortRows(rows) {
      const dir = (sortDir === "desc") ? -1 : 1;
      rows.sort((a, b) => {
        const av = getSortValue(a, sortKey);
        const bv = getSortValue(b, sortKey);
        if (av < bv) return -1 * dir;
        if (av > bv) return  1 * dir;
        return (a._date?.getTime?.() || 0) - (b._date?.getTime?.() || 0);
      });
    }

    function getSortValue(r, key) {
      if (key === "DATE") return (r._date instanceof Date ? r._date.getTime() : 0);
      if (key === "COST") return normalizeCost(r.COST || "");
      return String(r[key] || "").toLowerCase();
    }

    function normalizeCost(s) {
      const m = String(s || "").trim().match(/-?\d+(\.\d+)?/);
      return m ? Number(m[0]) : Number.POSITIVE_INFINITY;
    }

    function updateSortIndicators() {
      els.ths.forEach(th => {
        const key = th.getAttribute("data-key");
        const span = th.querySelector(".sort");
        if (!span) return;
        span.textContent = (key === sortKey) ? (sortDir === "asc" ? "▲" : "▼") : "";
      });

      const pretty = (k) => ({
        "DATE":"Date","STATE":"State","EVENT":"Event","HOST":"Hosted by",
        "COST":"Cost","DURATION":"Duration","GRADES":"Grades","URL":"Link"
      }[k] || k);

      els.sortLabel.textContent = `Sort: ${pretty(sortKey)} (${sortDir === "asc" ? "A→Z" : "Z→A"})`;
      if (sortKey === "DATE") els.sortLabel.textContent = `Sort: Date (${sortDir === "asc" ? "Old→New" : "New→Old"})`;
      if (sortKey === "COST") els.sortLabel.textContent = `Sort: Cost (${sortDir === "asc" ? "Low→High" : "High→Low"})`;
    }

    function renderCards(rows) {
      els.cards.innerHTML = rows.map(r => {
        const chips = [
          r.COST ? `<span class="chip">Cost: ${escapeHtml(r.COST)}</span>` : "",
          r.DURATION ? `<span class="chip">Duration: ${escapeHtml(r.DURATION)}</span>` : "",
          r.GRADES ? `<span class="chip">Grades: ${escapeHtml(r.GRADES)}</span>` : "",
        ].filter(Boolean).join("");

        return `
          <div class="card">
            <div class="row1">
              <div class="left">
                <div class="title" title="${escapeAttr(r.EVENT)}">${escapeHtml(r.EVENT)}</div>
                <div class="sub">${escapeHtml(r.HOST || "")}</div>
              </div>
              <div class="stamp">
                <div class="stampDate">${escapeHtml(formatDisplayDate(r._date))}</div>
                <div class="stampState">${escapeHtml(r.STATE || "")}</div>
              </div>
            </div>
            <div class="chips">${chips}</div>
            <div class="actions">
              <a class="btn" href="${escapeAttr(r.URL)}" target="_blank" rel="noopener">Open</a>
              <a class="btn secondary" href="${escapeAttr(buildCalendarLink(r))}" target="_blank" rel="noopener">Add to Calendar</a>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderTable(rows) {
      els.rows.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(formatDisplayDate(r._date))}</td>
          <td>${escapeHtml(r.STATE || "")}</td>
          <td>${escapeHtml(r.EVENT || "")}</td>
          <td>${escapeHtml(r.HOST || "")}</td>
          <td>${escapeHtml(r.COST || "")}</td>
          <td>${escapeHtml(r.DURATION || "")}</td>
          <td>${escapeHtml(r.GRADES || "")}</td>
          <td><a href="${escapeAttr(r.URL)}" target="_blank" rel="noopener">Open</a></td>
        </tr>
      `).join("");
    }

    function hydrateFilters(rows) {
      const states = new Set();
      const hosts = new Set();
      rows.forEach(r => {
        if (r.STATE) states.add(r.STATE);
        if (r.HOST) hosts.add(r.HOST);
      });
      setOptions(els.state, [...states].sort());
      setOptions(els.host, [...hosts].sort());
    }

    function setOptions(select, values) {
      const keep = select.value;
      select.innerHTML = `<option value="">All</option>` + values.map(v => `<option>${escapeHtml(v)}</option>`).join("");
      if (values.includes(keep)) select.value = keep;
    }

    function normalizeRow(r) {
      const out = {};
      out.STATE = String(r.STATE || "").trim().toUpperCase();
      out.EVENT = String(r.EVENT || "").trim();
      out.HOST = String(r.HOST || "").trim();
      out.URL = String(r.URL || "").trim();

      out.DATE = toISODate(r.DATE);
      out.GRADES = String(r.GRADES || "").trim();
      out.DURATION = String(r.DURATION || "").trim();
      out.COST = String(r.COST || "").trim();

      if (String(r.APPROVED || "").trim() === "") out.APPROVED = null;
      else {
        const v = String(r.APPROVED || "").trim().toLowerCase();
        out.APPROVED = (v === "true" || v === "yes" || v === "y" || v === "1");
      }

      out._date = parseISODate(out.DATE);
      return out;
    }

    function parseCsv(text) {
      const rows = [];
      let cur = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }
        if (!inQuotes && c === ",") { cur.push(field); field = ""; continue; }

        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r" && next === "\n") i++;
          cur.push(field); field = "";
          if (cur.length > 1 || cur[0] !== "") rows.push(cur);
          cur = [];
          continue;
        }
        field += c;
      }

      cur.push(field);
      if (cur.length > 1 || cur[0] !== "") rows.push(cur);

      const headers = (rows.shift() || []).map(h => String(h || "").trim());
      return { headers, rows };
    }

    function toISODate(v) {
      const s = String(v || "").trim();
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (mdy) return `${mdy[3]}-${String(mdy[1]).padStart(2,"0")}-${String(mdy[2]).padStart(2,"0")}`;

      const d = new Date(s);
      if (!isNaN(d.getTime())) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      return s;
    }

    function parseISODate(s) {
      const m = String(s || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return new Date(NaN);
      return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
    }

    function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function formatDisplayDate(d) {
      try { return new Intl.DateTimeFormat(undefined, { month: "short", day: "numeric", year: "numeric" }).format(d); }
      catch { return String(d); }
    }

    function buildCalendarLink(r) {
      const start = r._date;
      const end = new Date(start.getTime() + 60 * 60 * 1000);

      const fmt = d => {
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, "0");
        const day = String(d.getUTCDate()).padStart(2, "0");
        return `${y}${m}${day}T000000Z`;
      };

      const dates = `${fmt(start)}/${fmt(end)}`;
      const text = encodeURIComponent(r.EVENT);
      const details = encodeURIComponent(`${r.HOST}\n${r.URL}`);
      const loc = encodeURIComponent(r.STATE || "");
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(s) { return escapeHtml(s).replaceAll("`", "&#096;"); }
  </script>
</body>
</html>
