<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Football Camps & Combines</title>
  <style>
    * { box-sizing: border-box; }
    :root { --shadow: 0 6px 18px rgba(0,0,0,.08); --stickyOffset: 0px; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #fafafa; color: #111; }
    header { position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #eee; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }

    .controls {
      display: grid;
      grid-template-columns: 1fr 160px 220px 180px 180px 160px;
      gap: 10px;
      align-items: end;
    }
    .controls > div, .controls .pill { min-width: 0; }
    .controls label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
    .controls input, .controls select {
      width: 100%;
      min-width: 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 999px; background: #fff; font-size: 14px; }
    .pill input { width: 18px; height: 18px; }

    .meta { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; font-size: 12px; color: #555; }
    .badge { padding: 6px 10px; border-radius: 999px; background: #fff; border: 1px solid #eee; }
    .error { display: none; margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid #f2c6cc; background: #fff; color: #b00020; white-space: pre-wrap; }

    main { padding: 18px 14px 40px; }
    .grid { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 16px; box-shadow: var(--shadow); padding: 14px; }
    .row1 { display: flex; justify-content: space-between; gap: 10px; align-items: start; }
    .title { font-size: 15px; font-weight: 700; margin: 0 0 6px; line-height: 1.25; }
    .sub { font-size: 13px; color: #444; margin: 0; }
    .right { text-align: right; min-width: 110px; }
    .date { font-weight: 700; font-size: 14px; }
    .state { font-size: 12px; color: #555; margin-top: 4px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .chip { font-size: 12px; padding: 6px 10px; border-radius: 999px; background: #f6f6f6; border: 1px solid #eee; }
    .actions { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { display: inline-flex; justify-content: center; align-items: center; padding: 10px 12px; border-radius: 12px; border: 1px solid #ddd; background: #fff; text-decoration: none; color: #111; font-weight: 600; font-size: 14px; }

    .tableWrap { max-width: 1100px; margin: 0 auto; display: none; }
    table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #eee; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px; vertical-align: top; }
    th { text-align: left; font-size: 12px; color: #444; background: #fbfbfb; position: sticky; top: var(--stickyOffset); z-index: 5; }
    tr:hover td { background: #fcfcfc; }
    a { color: inherit; }

    @media (min-width: 900px) {
      .grid { display: none; }
      .tableWrap { display: block; }
      h1 { font-size: 20px; }
    }
    @media (max-width: 900px) {
      .controls { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px) {
      .controls { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header id="pageHeader">
    <div class="wrap">
      <h1>Football Camps / Combines / Junior Days</h1>

      <div class="controls">
        <div>
          <label>Search</label>
          <input id="q" placeholder="School, camp name, host..." />
        </div>

        <div>
          <label>State</label>
          <select id="state"><option value="">All</option></select>
        </div>

        <div>
          <label>Hosted By</label>
          <select id="host"><option value="">All</option></select>
        </div>

        <div>
          <label>Start date</label>
          <input id="from" type="date" />
        </div>

        <div>
          <label>End date</label>
          <input id="to" type="date" />
        </div>

        <div class="pill">
          <input id="upcoming" type="checkbox" checked />
          <span>Upcoming only</span>
        </div>
      </div>

      <div class="meta">
        <span class="badge" id="count">Loading…</span>
        <span class="badge" id="updated"></span>
      </div>

      <div class="error" id="err"></div>
    </div>
  </header>

  <main>
    <div class="grid" id="cards"></div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">Date</th>
            <th style="width:60px;">State</th>
            <th>Event</th>
            <th style="width:220px;">Hosted by</th>
            <th style="width:110px;">Cost</th>
            <th style="width:110px;">Duration</th>
            <th style="width:150px;">Grades</th>
            <th style="width:80px;">Link</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <script>
    const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTMvr__OkB3wgl4GvpZLJ61u_MfemESGiLBKEwufYFVwj_S7jiHFZraACGJRJogY6I29r17w34EGzVF/pub?gid=700608427&single=true&output=csv";
    const CSV_URL = new URLSearchParams(location.search).get("csv") || DEFAULT_CSV_URL;

    const REQUIRED = ["STATE", "DATE", "EVENT NAME", "HOSTED BY", "URL"];

    const els = {
      header: document.getElementById("pageHeader"),
      q: document.getElementById("q"),
      state: document.getElementById("state"),
      host: document.getElementById("host"),
      from: document.getElementById("from"),
      to: document.getElementById("to"),
      upcoming: document.getElementById("upcoming"),
      count: document.getElementById("count"),
      updated: document.getElementById("updated"),
      err: document.getElementById("err"),
      cards: document.getElementById("cards"),
      rows: document.getElementById("rows"),
    };

    let all = [];
    const dateFmt = new Intl.DateTimeFormat("en-US", { month: "short", day: "numeric", year: "numeric" });

    init();

    async function init() {
      setStickyOffset();
      setupAutoHeightPostMessage();

      if (!CSV_URL) return showError("CSV_URL is not set.");

      const started = performance.now();
      let text;

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        text = await res.text();
      } catch (e) {
        showError(`Could not load CSV.\n\n${String(e)}`);
        els.count.textContent = "0 event(s) shown";
        return;
      }

      const parsed = parseCsv(text);
      const headersU = parsed.headers.map(normHeader);
      validateHeaders(headersU);

      all = parsed.rows
        .map(row => toCanonical(parsed.headers, row))
        .filter(r => r.URL && r.EVENT_NAME && r.DATE_ISO)
        .map(r => ({ ...r, _date: parseISODate(r.DATE_ISO), DATE_DISPLAY: formatDisplayDate(r.DATE_ISO) }));

      all = dedupe(all);
      hydrateFilters(all);

      const ms = Math.round(performance.now() - started);
      els.updated.textContent = `Loaded ${all.length} events • ${ms}ms`;

      wire();
      render();
      postEmbedHeightSoon();
    }

    function setupAutoHeightPostMessage() {
      if (!window.parent || window.parent === window) return;
      const send = () => {
        const h = Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
        window.parent.postMessage({ type: "MYRECRUITS_EMBED_HEIGHT", height: h }, "*");
      };
      window.addEventListener("load", send);
      const ro = new ResizeObserver(() => send());
      ro.observe(document.documentElement);
      setInterval(send, 1500);
      window.__sendEmbedHeight = send;
    }

    function postEmbedHeightSoon() {
      if (typeof window.__sendEmbedHeight === "function") setTimeout(() => window.__sendEmbedHeight(), 200);
    }

    function setStickyOffset() {
      const set = () => {
        const h = els.header?.offsetHeight || 0;
        document.documentElement.style.setProperty("--stickyOffset", `${h}px`);
      };
      set();
      window.addEventListener("resize", set);
    }

    function wire() {
      ["input", "change"].forEach(evt => {
        els.q.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
        els.state.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
        els.host.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
        els.from.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
        els.to.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
        els.upcoming.addEventListener(evt, () => { render(); postEmbedHeightSoon(); });
      });
    }

    function render() {
      const q = (els.q.value || "").trim().toLowerCase();
      const state = els.state.value;
      const host = els.host.value;
      const from = els.from.value ? new Date(els.from.value + "T00:00:00") : null;
      const to = els.to.value ? new Date(els.to.value + "T00:00:00") : null;
      const upcomingOnly = els.upcoming.checked;

      const today = startOfDay(new Date());

      let filtered = all.filter(r => {
        if (upcomingOnly && r._date < today) return false;
        if (state && r.STATE !== state) return false;
        if (host && r.HOSTED_BY !== host) return false;
        if (from && r._date < from) return false;
        if (to && r._date > to) return false;

        if (q) {
          const blob = [
            r.STATE, r.DATE_ISO, r.EVENT_NAME, r.HOSTED_BY, r.URL,
            r.COST || "", r.DURATION || "", r.GRADES || ""
          ].join(" ").toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });

      filtered.sort((a, b) => a._date - b._date);

      els.count.textContent = `${filtered.length} event(s) shown`;
      renderCards(filtered);
      renderTable(filtered);
    }

    function renderCards(rows) {
      els.cards.innerHTML = rows.map(r => {
        const chips = [
          r.COST ? `<span class="chip">Cost: ${escapeHtml(r.COST)}</span>` : "",
          r.DURATION ? `<span class="chip">Duration: ${escapeHtml(r.DURATION)}</span>` : "",
          r.GRADES ? `<span class="chip">${escapeHtml(r.GRADES)}</span>` : "",
        ].filter(Boolean).join("");

        return `
          <div class="card">
            <div class="row1">
              <div>
                <div class="title">${escapeHtml(r.EVENT_NAME)}</div>
                <div class="sub">${escapeHtml(r.HOSTED_BY)}</div>
              </div>
              <div class="right">
                <div class="date">${escapeHtml(r.DATE_DISPLAY)}</div>
                <div class="state">${escapeHtml(r.STATE || "")}</div>
              </div>
            </div>
            <div class="chips">${chips}</div>
            <div class="actions">
              <a class="btn" href="${escapeAttr(r.URL)}" target="_blank" rel="noopener">Open</a>
              <a class="btn" href="${escapeAttr(buildCalendarLink(r))}" target="_blank" rel="noopener">Add to Calendar</a>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderTable(rows) {
      els.rows.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.DATE_DISPLAY)}</td>
          <td>${escapeHtml(r.STATE || "")}</td>
          <td>${escapeHtml(r.EVENT_NAME)}</td>
          <td>${escapeHtml(r.HOSTED_BY)}</td>
          <td>${escapeHtml(r.COST || "")}</td>
          <td>${escapeHtml(r.DURATION || "")}</td>
          <td>${escapeHtml(r.GRADES || "")}</td>
          <td><a href="${escapeAttr(r.URL)}" target="_blank" rel="noopener">Open</a></td>
        </tr>
      `).join("");
    }

    function hydrateFilters(rows) {
      const states = new Set();
      const hosts = new Set();
      rows.forEach(r => {
        if (r.STATE) states.add(r.STATE);
        if (r.HOSTED_BY) hosts.add(r.HOSTED_BY);
      });
      setOptions(els.state, [...states].sort());
      setOptions(els.host, [...hosts].sort());
    }

    function setOptions(select, values) {
      const keep = select.value;
      select.innerHTML = `<option value="">All</option>` + values.map(v => `<option>${escapeHtml(v)}</option>`).join("");
      if (values.includes(keep)) select.value = keep;
    }

    function dedupe(rows) {
      const seen = new Set();
      const out = [];
      for (const r of rows) {
        const key = [r.DATE_ISO, r.STATE, r.HOSTED_BY, r.EVENT_NAME, r.URL].join("|").toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(r);
      }
      return out;
    }

    function validateHeaders(headersUpper) {
      for (const req of REQUIRED) {
        if (!headersUpper.includes(req)) throw new Error(`Missing required column: ${req}`);
      }
    }

    function toCanonical(headers, row) {
      const obj = {};
      for (let i = 0; i < headers.length; i++) obj[normHeader(headers[i])] = String(row[i] ?? "").trim();

      const STATE = pick(obj, ["STATE", "ST"]);
      const DATE_RAW = pick(obj, ["DATE", "START DATE", "STARTDATE", "START"]);
      const EVENT_NAME = pick(obj, ["EVENT NAME", "EVENT", "NAME", "TITLE"]);
      const HOSTED_BY = pick(obj, ["HOSTED BY", "HOST", "ORGANIZER", "SCHOOL"]);
      const URL = pick(obj, ["URL", "LINK"]);

      const COST = pick(obj, ["COST", "PRICE", "FEE"]);
      const DURATION = pick(obj, ["DURATION", "LENGTH"]);
      const GRADES = pick(obj, ["GRADES/AGE", "GRADES", "AGE", "GRADESAGE"]);

      const DATE_ISO = toISODate(DATE_RAW);

      return {
        STATE: (STATE || "").toUpperCase(),
        DATE_ISO,
        EVENT_NAME,
        HOSTED_BY,
        URL,
        COST,
        DURATION,
        GRADES,
      };
    }

    function pick(obj, keys) {
      for (const k of keys) {
        const kk = normHeader(k);
        if (obj[kk]) return obj[kk];
      }
      return "";
    }

    function normHeader(h) { return String(h || "").trim().toUpperCase(); }

    function parseCsv(text) {
      const rows = [];
      let cur = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && c === ",") { cur.push(field); field = ""; continue; }
        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r" && next === "\n") i++;
          cur.push(field); field = "";
          if (cur.length > 1 || cur[0] !== "") rows.push(cur);
          cur = [];
          continue;
        }
        field += c;
      }
      cur.push(field);
      if (cur.length > 1 || cur[0] !== "") rows.push(cur);

      const headers = (rows.shift() || []).map(h => String(h || "").trim());
      return { headers, rows };
    }

    function toISODate(v) {
      const s = String(v || "").trim();
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (mdy) {
        const mm = String(mdy[1]).padStart(2, "0");
        const dd = String(mdy[2]).padStart(2, "0");
        return `${mdy[3]}-${mm}-${dd}`;
      }

      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${d.getFullYear()}-${mm}-${dd}`;
      }
      return "";
    }

    function parseISODate(s) {
      const m = String(s || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return new Date(0);
      return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
    }

    function formatDisplayDate(iso) {
      const d = parseISODate(iso);
      if (isNaN(d.getTime()) || d.getTime() === 0) return iso || "";
      return dateFmt.format(d);
    }

    function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function buildCalendarLink(r) {
      const start = r._date;
      const end = new Date(start.getTime() + 60 * 60 * 1000);
      const fmt = d => {
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, "0");
        const day = String(d.getUTCDate()).padStart(2, "0");
        return `${y}${m}${day}T000000Z`;
      };
      const dates = `${fmt(start)}/${fmt(end)}`;
      const text = encodeURIComponent(r.EVENT_NAME);
      const details = encodeURIComponent(`${r.HOSTED_BY}\n${r.URL}`);
      const loc = encodeURIComponent(r.STATE || "");
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
    }

    function showError(msg) {
      els.err.style.display = "block";
      els.err.textContent = msg;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(s) { return escapeHtml(s).replaceAll("`", "&#096;"); }
  </script>
</body>
</html>
